{% extends 'base.html' %}

{% load static %}

{% block content %}
<div class="main-content-wrapper">
    <main class="main-content">
        <div class="container-fluid">
            <h1>Hello World</h1>
            
            <div class="card">
                <div class="card-header">
                    Run "echo" for different languages
                </div>
                <div class="card-body">
                    <select id="greeting-select"></select>
                    <button id="run-button" class="btn btn-primary">Run</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    Experiments
                </div>
                <div class="card-body">
                    <button id="refresh-button" class="btn btn-secondary">Refresh</button>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Application</th>
                                <th scope="col">Creation Time</th>
                                <th scope="col">Status</th>
                                <th scope="col">Output</th>
                            </tr>
                        </thead>
                        <tbody id="experiment-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock content %}

{% block scripts %}
<script src="{% static 'django_airavata_api/dist/airavata-api.js' %}"></script>
<script>
    const { models, services, session, utils } = AiravataAPI;
    
    utils.FetchUtils.get("/gateways19_tutorial/languages")
        .then(data => {
            data.languages.forEach(language => {
                $("#greeting-select").append(
                    `<option value="${language.greeting}">
                        ${language.lang} - "${language.greeting}"
                     </option>`
                )
            })
        });

    const appInterfaceId = "Echo_4be0e1b0-24c5-417d-8d57-a695c2890a05";

    const FAKE_STDOUT = `
stdout [Echo bonjour]
Echoed_Output=bonjour
Job Cleanup ran on Fri Jul 19 12:34:39 EDT 2019
===============================
submit_args  : 	 submit_args = /N/dc2/scratch/cgateway/gta-work-dirs/PROCESS_3db6a570-f150-4e01-b659-d422c5e38b32/job_349221662.pbs
NIDS         : 	 5
NID Placement: 	 5/4 
`;

    function loadExperiments() {

        return services.ExperimentSearchService
            .list({limit: 5,
                [models.ExperimentSearchFields.USER_NAME.name]: session.Session.username,
                [models.ExperimentSearchFields.APPLICATION_ID.name]: appInterfaceId,
            })
            .then(data => {
                $('#experiment-list').empty();
                data.results.forEach((exp, index) => {
                    $('#experiment-list').append(
                    `<tr>
                        <td>${exp.name}</td>
                        <td>${exp.executionId}</td>
                        <td>${exp.creationTime}</td>
                        <td>${exp.experimentStatus.name}</td>
                        <td id="output_${index}"></td>
                    </tr>`);
                    // If experiment has finished, load full details, then parse the stdout file
                    if (exp.experimentStatus === models.ExperimentState.COMPLETED) {
                        services.FullExperimentService.retrieve({lookup: exp.experimentId})
                        .then(fullDetails => {
                            const stdoutDataProductId = fullDetails.experiment.experimentOutputs.find(o => o.name === "Standard Out").value;
                            const stdoutDataProduct = fullDetails.outputDataProducts.find(dp => dp.productUri === stdoutDataProductId);
                            if (stdoutDataProduct && stdoutDataProduct.downloadURL) {
                                return fetch(stdoutDataProduct.downloadURL, {
                                    credentials: "same-origin"
                                })
                                .then(result => result.text())
                            } else {
                                // If we can't download it, fake it
                                return FAKE_STDOUT;
                            }
                        })
                        .then(text => {
                            const regex = /Echoed_Output=(.*)$/m;
                            const result = regex.exec(text);
                            if (result) {
                                $(`#output_${index}`).text(result[1]);
                            }
                        })
                    }
                });
        });
    }

    loadExperiments();
    $("#refresh-button").click(loadExperiments);

    $("#run-button").click(e => {
        const greeting = $("#greeting-select").val();
        const loadAppInterface = services.ApplicationInterfaceService.retrieve({lookup: appInterfaceId});
        const appDeploymentId = "pearc19-sgrc-cluster.jetstream-cloud.org_Echo_b0e05d53-cace-420b-b280-3626e5e1c94b";
        const loadQueues = services.ApplicationDeploymentService.getQueues({ lookup: appDeploymentId });
        const resourceHostId = "pearc19-sgrc-cluster.jetstream-cloud.org_cf5b3c5d-f524-4c66-883a-03662caa8178";
        const queueName = "cloud";
        const groupResourceProfileId = "573573a8-8084-459f-9a4a-138ab835b7b3";
        const loadWorkspacePrefs = services.WorkspacePreferencesService.get();
        Promise.all([loadAppInterface, loadWorkspacePrefs, loadQueues])
        .then(([appInterface, workspacePrefs, queues]) => {
            const experiment = appInterface.createExperiment();
            experiment.experimentName = "Echo " + greeting;
            experiment.projectId = workspacePrefs.most_recent_project_id;
            const cloudQueue = queues.find(q => q.queueName === queueName);
            experiment.userConfigurationData.groupResourceProfileId = groupResourceProfileId;
            experiment.userConfigurationData.computationalResourceScheduling.resourceHostId = resourceHostId;
            experiment.userConfigurationData.computationalResourceScheduling.totalCPUCount = cloudQueue.defaultCPUCount;
            experiment.userConfigurationData.computationalResourceScheduling.nodeCount = cloudQueue.defaultNodeCount;
            experiment.userConfigurationData.computationalResourceScheduling.wallTimeLimit = cloudQueue.defaultWalltime;
            // Copy the selected greeting to the value of the first input
            experiment.experimentInputs[0].value = greeting;

            return services.ExperimentService.create({data: experiment});
        }).then(exp => {
            return services.ExperimentService.launch({lookup: exp.experimentId});
        })
    });

</script>

{% endblock scripts %}
